<!DOCTYPE html>
<html lang="en">
<head>
  	<meta charset="UTF-8">
  	<title>Chinese map Demo</title>
  	<link rel="stylesheet" href="style/style.css">
  	<link rel="stylesheet" href="style/d3.slider.css">  
  	<style>
		body {
		  margin: 0;
		  font-size: 14px;
		  font-family: "Helvetica Neue", Helvetica;
		}
		#chart {
		  position: absolute;
		  top: 50px;
		  left: 1000px;
		}	
	</style>
</head>
<body>
	
	<!-- map and scatter -->
	<div id="china-map"></div>
	<div id="body">
	<div id="chart"></div></div>
	<!-- slider for map -->
	<div id="slider" class="slider"></div>
	<span id="slider3textmin"></span>, <span id="slider3textmax"></span>

	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>
	<script src="js/RadarChart.js"></script>
	<script src="js/d3.slider.js"></script>
	<!-- <script src="map.js"></script> -->
	<script>
		var w = 500, 
		h = 500;

		var colorscale = d3.scale.category10();

		//Legend titles
		var LegendOptions = ['Beijing'];

		//Data
		var social = [
				  [
					{axis:"GDP",value:0.9016855545631348},
					{axis:"GDP per capita", value:0.3017333866481376},
					{axis:"Green Covered Area %",value:0.6552526166},
					{axis:"Secondary Industry %",value:0.2232},
					{axis:"Population Density",value:0.30184264398717114},
					{axis:"Population",value:0.3857065576726573}
				  ]
				];

		//Options for the Radar chart, other than default
		var mycfg = {
		  w: w,
		  h: h,
		  maxValue: 0.6,
		  levels: 6,
		  ExtraWidthX: 300
		}

		//Call function to draw the Radar chart
		//Will expect that data is in %'s
		RadarChart.draw("#chart", social, mycfg);

		////////////////////////////////////////////
		/////////// Initiate legend ////////////////
		////////////////////////////////////////////

		var svg1 = d3.select('#body')
			.selectAll('svg')
			.append('svg')
			.attr("width", w+300)
			.attr("height", h)
		//Create the title for the legend
		var text = svg1.append("text")
			.attr("class", "title")
			.attr('transform', 'translate(90,0)') 
			.attr("x", w - 70)
			.attr("y", 10)
			.attr("font-size", "12px")
			.attr("fill", "#404040")
			.text("Cities");
				
		//Initiate Legend	
		var legend = svg1.append("g")
			.attr("class", "legend")
			.attr("height", 100)
			.attr("width", 200)
			.attr('transform', 'translate(90,20)') 
			;
			//Create colour squares
			legend.selectAll('rect')
			  .data(LegendOptions)
			  .enter()
			  .append("rect")
			  .attr("x", w - 65)
			  .attr("y", function(d, i){ return i * 20;})
			  .attr("width", 10)
			  .attr("height", 10)
			  .style("fill", function(d, i){ return colorscale(i);})
			  ;
			//Create text next to squares
			legend.selectAll('text')
			  .data(LegendOptions)
			  .enter()
			  .append("text")
			  .attr("x", w - 52)
			  .attr("y", function(d, i){ return i * 20 + 9;})
			  .attr("font-size", "11px")
			  .attr("fill", "#737373")
			  .text(function(d) { return d; })
			  ;
		console.log(svg1);
	    var width = 1300;
	    var height = 850;

	    var svg = d3.select("#china-map").append("svg")
	        .attr("width", width)
	        .attr("height", height)
	        .append("g")
	        .attr("transform", "translate(0,0)");

	    var projection = d3.geo.mercator()
	        .center([107, 31])
	        .scale(700)
	        .translate([width / 2, height / 2]);

	    var path = d3.geo.path()
	        .projection(projection);


        queue()
            .defer(d3.json, "data/map_data.json")
            .defer(d3.json, "data/all.json")
            .await(ready);  


	    function ready(error, map, citydata) {
            if (error) throw error;

            let all_city = citydata
            let filter_city = citydata
			var aqi_min = Math.min(...citydata.map( a => a.value[2])) + 50;
			var aqi_max = Math.max(...citydata.map( a => a.value[2])) - 69;
			var aqi_quarter1 = aqi_min + (aqi_max - aqi_min) / 3;
			var aqi_quarter2 = aqi_max - (aqi_max - aqi_min) / 3;

    		var dotColorScale = d3.scale.linear()
        		.domain([aqi_min, aqi_quarter1, aqi_quarter2, aqi_max])
        		.range(['#2196F3', '#FFC107', '#FF5722','#F44336']);

        	// map tooltip
	        var tooltip_map = d3.select("body")
	            .append("div")
	            .attr("class", "tooltip_map")
	            .style("opacity", 0);

        	// aqi scatter tooltip
	        var tooltip_aqi = d3.select("body")
	            .append("div")
	            .attr("class", "tooltip_aqi")
	            .style("opacity", 0);

	        // draw map
	        chinaMap(map, tooltip_map);

	        // draw scatter
	        aqiScatter(all_city, dotColorScale, tooltip_aqi);

	        // slider for scatter	    
		    d3.select('#slider').call(d3.slider().value([0, 300]).axis(true).min(0).max(300).on("slide", function(evt, value) {
		        filter_city = citydata.filter(a => a.value[2] > value[0] && a.value[2] < value[1]);
		        svg.selectAll("circle").remove();
		        aqiScatter(filter_city, dotColorScale, tooltip_aqi);
		    }));	    

        }


        function chinaMap(root, tooltip_map){
	        svg.selectAll("path")
	            .data(root.features)
	            .enter()
	            .append("path")
	            .attr("stroke", "#111")
	            .attr("stroke-width", 1)
	            .attr("fill", function(d, i) {
	                return "#323c48";
	            })
	            .attr("d", path)
	            .on("mouseover", function(d, i) {
	                d3.select(this).attr("fill", "#2a333d");
	                tooltip_map.transition()
	                    .duration(200)
	                    .style("opacity", .9);

	                tooltip_map.html(d.properties.name)
	                	.style("color", "#bbb")
	                    .style("left", (d3.event.pageX) + "px")
	                    .style("top", (d3.event.pageY - 28) + "px");
	            })
	            .on("mouseout", function(d, i) {
	                d3.select(this).attr("fill", "#323c48");
	                tooltip_map.transition()
	                    .duration(500)
	                    .style("opacity", 0);
	            });
        }

        function aqiScatter(slide_data, dotColorScale, tooltip_aqi){
            svg.selectAll("circle")
                .data(slide_data)
                .enter()
                .append("circle")
                .attr("class","map")
                .attr("cx",function(d) {return projection([d.value[0],d.value[1]])[0]})
                .attr("cy",function(d) {return projection([d.value[0],d.value[1]])[1]})
                .attr("r", 4.5)  
                .style("fill", function(d) {return dotColorScale(d.value[2])})
                .style("opacity",.8)
                .on("mouseover", function(d) {   
	                d3.select(this).attr("r", 14);
	                d3.select(this).attr("opacity", 1);
	                tooltip_aqi.transition()
	                    .duration(200)
	                    .style("opacity", 0.9);

	                tooltip_aqi.html(d.name + "<br>AQI: " + d.value[2])
	                    .style("left", (d3.event.pageX + 20) + "px")
	                    .style("top", (d3.event.pageY - 28) + "px");
                    })                  
                .on("mouseout", function(d) {       
	                d3.select(this).attr("r", 4.5);
	                d3.select(this).attr("opacity", .8);
	                tooltip_aqi.transition()
	                    .duration(500)
	                    .style("opacity", 0);               
                })

                // tian ma 
                .on("click", function(d){
                	console.log(d)
                	if (LegendOptions.length >= 3) {
                		LegendOptions = [];
                		social = [];
                	}
                	LegendOptions.push(d['name']);
                	social.push(
                		[
							{axis:"GDP",value:d['social']['GDP']},
							{axis:"GDP per capita", value:d['social']['GDP_per_capita']},
							{axis:"Green Covered Area %",value:d['social']['Green_Covered_Area_percentage']},
							{axis:"Secondary Industry %",value:d['social']['secondary_industry_percentage']},
							{axis:"Population Density",value:d['social']['Population_Density']},
							{axis:"Population",value:d['social']['population']}
		  				])
                	RadarChart.draw("#chart", social, mycfg);
                		svg1 = d3.select('#body')
							.selectAll('svg')
							.append('svg')
							.attr("width", w + 300)
							.attr("height", h)
						text = svg1.append("text")
							.attr("class", "title")
							.attr('transform', 'translate(90,0)') 
							.attr("x", w - 70)
							.attr("y", 10)
							.attr("font-size", "12px")
							.attr("fill", "#404040")
							.text("Cities");
						legend = svg1.append("g")
						.attr("class", "legend")
						.attr("height", 100)
						.attr("width", 200)
						.attr('transform', 'translate(90,20)') 
						;
						//Create colour squares
						legend.selectAll('rect')
						  .data(LegendOptions)
						  .enter()
						  .append("rect")
						  .attr("x", w - 65)
						  .attr("y", function(d, i){ return i * 20;})
						  .attr("width", 10)
						  .attr("height", 10)
						  .style("fill", function(d, i){ return colorscale(i);})
						  ;
						//Create text next to squares
						legend.selectAll('text')
						  .data(LegendOptions)
						  .enter()
						  .append("text")
						  .attr("x", w - 52)
						  .attr("y", function(d, i){ return i * 20 + 9;})
						  .attr("font-size", "11px")
						  .attr("fill", "#737373")
						  .text(function(d) { return d; })
						  ;
                });
        }


	</script>


</body>
</html>
